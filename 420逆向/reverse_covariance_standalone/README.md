# 逆向协方差矩阵估计工具

## 简介

从 **105 个投资组合的配置** 反推出 **4 种资产的协方差矩阵**。

适用于：
- 新产品设计阶段的资产特性校准
- 反向工程已有投资组合
- 快速验证组合风险的一致性

## 快速开始

### 1. 安装依赖
```bash
pip install numpy pandas
```

### 2. 运行
```bash
python reverse_covariance.py
```

### 3. 查看输出
自动生成 4 个 CSV 文件：
- `reverse_covariance_matrix.csv` - 协方差矩阵 (4×4)
- `reverse_correlation_matrix.csv` - 相关系数矩阵 (4×4)
- `reverse_volatility.csv` - 各资产波动率 (4 个)
- `reverse_portfolio_volatility.csv` - 105 个组合的重构结果

## 输入数据

### 文件格式: `105.csv`

```csv
组合ID,用户标签,风险偏好,风险等级,现金%,债券%,股票%,另类%
5,刚毕业,保值,C5,15,25,50,10
98,退休,增值,C3,35,30,28,7
...
```

**关键列**:
- **风险等级** (C1~C5): 映射到目标波动率 (7%~15%)
- **4 种资产权重**: 现金、债券、股票、另类 (百分比)

## 核心算法

### 问题定义

**已知**:
- 105 个组合的权重 `w₁, w₂, ..., w₁₀₅`
- 每个组合的目标风险 `σ₁, σ₂, ..., σ₁₀₅`

**求解**:
- 4×4 协方差矩阵 `Σ`，使得 `√(wᵢᵀ Σ wᵢ) ≈ σᵢ` 对所有组合成立

### 数学模型

**组合方差公式**:
```
σₚ² = wᵀ Σ w
```

**优化目标** (最小二乘):
```
min Σᵢ (σₚ,ᵢ² - σₜₐᵣ,ᵢ²)²
```

**求解方法**: 正规方程
```
θ* = (AᵀA)⁻¹ Aᵀb
```

其中 θ 是协方差矩阵的 10 个独立参数 (4×4 对称矩阵)。

## 典型输出示例

### 协方差矩阵
```
        现金      债券      股票      另类
现金  0.3534  -0.1561  -0.4396  -0.1224
债券 -0.1561   0.0786   0.2274   0.0766
股票 -0.4396   0.2274   0.7009   0.2625
另类 -0.1224   0.0766   0.2625   0.1218
```

### 各资产波动率
```
现金: 59.45%
债券: 28.03%
股票: 83.72%
另类: 34.90%
```

### 相关系数矩阵
```
        现金     债券     股票     另类
现金   1.00  -0.937  -0.883  -0.590
债券  -0.937  1.00    0.969   0.783
股票  -0.883  0.969   1.00    0.898
另类  -0.590  0.783   0.898   1.00
```

**关键发现**:
- 现金与债券**高度负相关** (-0.937) ← 保守组合的"替代"关系
- 债券与股票**高度正相关** (0.969) ← 债券包含风险品种
- 股票与另类**高度正相关** (0.898) ← 另类资产跟随股市

## 文档说明

| 文件 | 内容 |
|------|------|
| `USAGE.md` | **使用指南** - 详细的运行说明和参数解释 |
| `数据原理解释.md` | **数学原理** - 完整的公式推导和算法实现 |
| `README.md` | **本文档** - 快速入门和项目概览 |

## 常见问题

### Q: 为什么现金波动率这么高？
现金占比在不同组合间差异很大 (0%~90%)，作为"缓冲资产"承担了组合调节的作用。这是数学上的最优解，不反映现金的真实市场风险。

### Q: 行顺序会影响结果吗？
**不会**。最小二乘法基于矩阵求和，与行顺序无关。即使打乱 105 行，结果完全一致 (误差 < 10⁻¹⁵)。

### Q: 如何验证结果正确性？
检查 `reverse_portfolio_volatility.csv` 中的误差列：
```python
errors = results_df['误差']
print(f"均方根误差: {np.sqrt((errors**2).mean()):.4f}")
```
典型 RMSE 在 1%~2% 范围内表示结果可靠。

### Q: 可以添加约束吗 (如非负、半正定)？
当前实现是无约束最小二乘。如需添加约束，可使用 `scipy.optimize.minimize` 替代解析解。详见 `USAGE.md` 的高级用法章节。

## 技术规格

- **Python 版本**: 3.9+ (兼容生产环境)
- **依赖库**: numpy, pandas (无 scipy 依赖)
- **计算复杂度**: O(n × p²) ≈ 0.1ms (n=105, p=10)
- **数值稳定性**: 使用正规方程 + 伪逆保障

## 文件清单

```
reverse_covariance_standalone/
├── reverse_covariance.py              # 核心算法脚本
├── 105.csv                            # 输入: 105个组合配置
├── README.md                          # 本文档
├── USAGE.md                           # 详细使用指南
├── 数据原理解释.md                     # 数学原理推导
├── reverse_covariance_matrix.csv      # 输出1: 协方差矩阵
├── reverse_correlation_matrix.csv     # 输出2: 相关系数矩阵
├── reverse_volatility.csv             # 输出3: 资产波动率
└── reverse_portfolio_volatility.csv   # 输出4: 组合重构结果
```

## 引用

**算法来源**:
- Markowitz, H. (1952). Portfolio Selection. *Journal of Finance*.
- Lawson & Hanson (1995). *Solving Least Squares Problems*. SIAM.

**相关论文**:
- Inverse Covariance Estimation in Graphical Models
- Tikhonov Regularization for Ill-Posed Problems

## 许可证

MIT License

## 更新日志

- **v1.0** (2026-01-23): 初始版本
  - 实现最小二乘逆向估计
  - 生成 4 个标准化输出文件
  - 完整文档和数学原理说明

---

**快速链接**:
- [详细使用指南](USAGE.md)
- [数学原理推导](数据原理解释.md)
- [GitHub Issues](https://github.com/...)
